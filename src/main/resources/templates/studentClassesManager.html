<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Assigner des étudiants</title>
  <link rel="stylesheet" href="${pageContext.request.contextPath}/css/styles.css">
</head>
<body>
<div th:include="~{elements/sidebar}"></div>
<div>
  <h1>Assignation d'étudiants à des classes</h1>
  <div th:if="${user == null or not user.hasRole('administrator')}">
    <p>Accès refusé. Vous devez être un administrateur pour accéder à cette page.</p>
    <a th:href="@{/index}">Retour à l'accueil</a>
  </div>

  <div th:if="${user != null and user.hasRole('administrator')}">
    <div th:if="${classe == null}">
      <h2>La classe n'existe pas</h2>
    </div>

    <div th:if="${classe != null}">
      <div id="OldInfos">
        <h3>Informations de la classe :</h3>
        <p th:text="'Nom : ' + ${classe.className}"></p>
      </div>

      <!-- Formulaire d'assignation -->
      <form action="studentClassesAssignation-servlet" method="post">
        <h3>Étudiant(s) disponible(s) :</h3>
        <div th:if="${#lists.isEmpty(availableStudents)}">
          <p>Aucun étudiant n'est disponible pour cette classe.</p>
        </div>

        <div th:if="${not #lists.isEmpty(availableStudents)}">
          <table border="1">
            <thead>
            <tr>
              <th>Nom de l'étudiant</th>
              <th>Prénom de l'étudiant</th>
              <th>Filière de l'étudiant</th>
              <th>Selection</th>
            </tr>
            </thead>
            <tbody>
            <th:block th:each="student : ${availableStudents}">
              <tr>
                <td th:text="${student.userLastName}"></td>
                <td th:text="${student.userName}"></td>
                <td>
                  <span th:text="${#lists.isEmpty(student.marjorId) ? 'Aucune' : student.majorName}"></span>
                </td>
                <td>
                  <input type="radio" name="studentId" th:value="${student.studentId}" />
                </td>
              </tr>
            </th:block>
            </tbody>
          </table>
          <input type="hidden" name="classesId" th:value="${classe.classId}" />
          <button type="submit" onclick="confirmAction(event, 'assign')">Assigner</button>
        </div>
      </form>

      <!-- Formulaire de désassignation -->
      <form action="studentClassesUnassignation-servlet" method="post">
        <h3>Étudiant(s) participant(s) :</h3>
        <div th:if="${#lists.isEmpty(participatingStudents)}">
          <p>Aucun étudiant n'est dans cette classe.</p>
        </div>

        <div th:if="${not #lists.isEmpty(participatingStudents)}">
          <table border="1">
            <thead>
            <tr>
              <th>Nom de l'étudiant</th>
              <th>Prénom de l'étudiant</th>
              <th>Filière de l'étudiant</th>
              <th>Selection</th>
            </tr>
            </thead>
            <tbody>
            <th:block th:each="student : ${participatingStudents}">
              <tr>
                <td th:text="${student.userLastName}"></td>
                <td th:text="${student.userName}"></td>
                <td>
                  <span th:text="${#lists.isEmpty(student.marjorId) ? 'Aucune' : student.majorName}"></span>
                </td>
                <td>
                  <input type="radio" name="studentId" th:value="${student.studentId}" />
                </td>
              </tr>
            </th:block>
            </tbody>
          </table>
          <input type="hidden" name="classesId" th:value="${classe.classId}" />
          <button type="submit" onclick="confirmAction(event, 'unassign')">Désassigner</button>
        </div>

        <!-- Affichage des erreurs -->
        <div th:if="${error != null}">
          <p style="color: red;" th:text="${error}"></p>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function confirmAction(event, action) {
    let confirmationMessage = '';

    if (action === 'assign') {
      confirmationMessage = "Êtes-vous sûr de vouloir assigner cet étudiant à cette classe ?";
    } else if (action === 'unassign') {
      confirmationMessage = "Êtes-vous sûr de vouloir désassigner cet étudiant à cette classe ?";
    }

    const confirmation = confirm(confirmationMessage);

    if (!confirmation) {
      event.preventDefault();
    }
  }
</script>
</body>
</html>
